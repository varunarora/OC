define(["jquery","filepicker","dropzone","underscore"],function(e,a,o,l){OC.config.uploads={filepicker_key:"AGuSaWwXNQFi60wveigBHz",store_error_code:151},filepicker.setKey(OC.config.uploads.filepicker_key),OC.upload={fp_uploaded_files:{},dropzone_uploaded_files:{},manual_to_upload_files:[],isPost:!1,launchFilepickerDialog:function(e,a){return filepicker.pickAndStore({multiple:!0,openTo:a},{location:"S3",path:"/",access:"public"},OC.upload.fpPost,OC.upload.fpError),e.preventDefault(),e.stopPropagation(),!1},uploadCallback:function(a){var o,l,p;o=a,e.extend(OC.upload.fp_uploaded_files,a);for(l in o)"failures"===l?(p=e(document.createElement("div")),p.html("The following files failed to upload: "),p.append(JSON.stringify(o.failures)),e(".uploadfiles").before(p)):(OC.upload.addToUploadList(l,o[l],"","filepicker-item"),OC.upload.newFileUploadListener())},fpPost:function(a){var o,l,p,d,i;for(p=a.length,o={},l=0;p>l;l++)d=a[l].key,i=a[l].filename,o[d]=i;o.user=OC.config.user.id,e("form input[name=project]").length>0&&(o.project=e("form input[name=project]").val()),e("form input[name=collection]").length>0&&(o.collection=e("form input[name=collection]").val()),e.post("/api/filepicker-upload/",o,OC.upload.uploadCallback,"json")},fpError:function(e){151===e&&alert("Sorry, something went wrong")},dzTemplate:l.template('<div class="dz-preview dz-file-preview <%= process %>"><div class="dz-details"><div class="dz-filename"><span data-dz-name contenteditable="true" class="<%= key %>"><%= filename %></span></div><div class="dz-size" data-dz-size><%= filesize %></div><img data-dz-thumbnail /></div><div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress></span></div><div class="dz-success-mark"><span>✔</span></div><div class="dz-error-mark"><span>✘</span></div><div class="dz-error-message"><span data-dz-errormessage></span></div></div>'),singleFileTemplate:l.template('<div class="single-upload <%= process %>"><input type="hidden" name="key" value="<%= key %>" /><input type="text" name="filename" value="<%= filename %>" /><input type="hidden" name="upload_service" value="<%= process %>" /><div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress></span></div><!--<select name="type"><option value="lesson">Lesson</option><option value="project">Project</option><option value="worksheet">Worksheet</option><option value="handout">Handout</option><option value="activity">Activity</option><option value="assessment">Test / assessment</option><option value="lecture">Lecture</option></select>--><div class="alternative-upload"><a>Upload something else instead...</a></div></div>'),newFileUploadListener:function(){var a=e("form.files-upload-rename button[type=submit]"),o=e('form.files-upload-rename button[name="select-file"]');a.hasClass("hidden")&&(e.isEmptyObject(OC.upload.fp_uploaded_files)&&e.isEmptyObject(OC.upload.dropzone_uploaded_files)&&!OC.upload.manual_to_upload_files.length||(a.removeClass("hidden"),OC.upload.isPost&&o.addClass("hidden")))},updateSingleItemKey:function(a){e(".post-new-upload-dialog .upload-drag-drop-replace input[name=key]").val(a)},addToUploadList:function(a,l,p,d){var i={key:a,filename:l,filesize:p,process:d};if(OC.upload.isPost){var n=e(".post-new-upload-dialog .upload-drag-drop,.post-new-upload-dialog .upload-drag-drop-message");n.addClass("hidden");var t=OC.upload.singleFileTemplate(i),s=e(".post-new-upload-dialog .upload-drag-drop-replace");s.html(t),s.removeClass("hidden"),e('input[type="filename"]',s).focus(),e(".alternative-upload a",s).click(function(){s.addClass("hidden"),n.removeClass("hidden");var a=e('input[class="manual-upload"]');e(a[a.length-2]).remove(),OC.upload.manual_to_upload_files=[],OC.upload.dropzone_uploaded_files={},o.forElement(".post-new-upload-dialog .upload-drag-drop").removeAllFiles(),OC.upload.fp_uploaded_files={};var l=e("form.files-upload-rename button[type=submit]"),p=e('form.files-upload-rename button[name="select-file"]');p.removeClass("hidden"),l.addClass("hidden")})}else{var u=OC.upload.dzTemplate(i);e(".post-new-upload-dialog .upload-drag-drop").append(u)}},onFileInputChange:function(){var a,o=e(this)[0].files[0].size;if(a=o>=1048576?(o/1048576).toFixed(2)+" MB":o>=1024?(o/1024).toFixed(2)+" KB":o+" B",o>5242880){var l=OC.customPopup(".upload-filepicker-suggest-dialog");e(".filepicker-suggest",l.dialog).click(function(e){return l.close(),e.preventDefault(),e.stopPropagation(),!1})}else{var p=e(this)[0].files[0].name;OC.upload.addToUploadList(p,p,a,"manual-item"),OC.upload.manual_to_upload_files.push(p),OC.upload.newFileUploadListener();var d=(e("form.files-upload-rename input.manual-upload").length,e("<input/>",{"class":"manual-upload",type:"file"}));d.change(OC.upload.onFileInputChange),e("form.files-upload-rename").append(d)}},preSubmissionHandler:function(){if(OC.upload.isPost){var a=e(".upload-drag-drop-replace"),o=e('input[name="key"]',a).val(),l=e('input[name="filename"]',a).val(),p=e('input[name="upload_service"]',a).val();if("filepicker-item"==p)e("<input/>").attr("type","hidden").attr("name",o).attr("value",l).appendTo(".files-upload-rename");else if("dropzone-item"==p)e("<input/>").attr("type","hidden").attr("name",o).attr("value",l).appendTo(".files-upload-rename");else{var d=e(".files-upload-rename input[class=manual-upload]");e(d[d.length-2]).attr("name",l)}}else{var i,n,t,s,u,r,f,c=e(".post-new-upload-dialog .upload-drag-drop .dz-preview"),m=e(".files-upload-rename input[type=file]");for(t=0;t<c.length;t++)if(u=c[t],r=e(".dz-filename span:first",u).attr("class"),f=e(".dz-filename span:first",u).text().trim(),e(u).hasClass("filepicker-item"))OC.upload.fp_uploaded_files[r]!=f&&(OC.upload.fp_uploaded_files[r]=f);else if(e(u).hasClass("manual-item"))for(s=0;s<m.length;s++)e(m[s]).val()!==r&&e(m[s]).attr("name",f);else OC.upload.dropzone_uploaded_files[r]!=f&&(OC.upload.dropzone_uploaded_files[r]=f);for(i in OC.upload.fp_uploaded_files)e("<input/>").attr("type","hidden").attr("name",i).attr("value",OC.upload.fp_uploaded_files[i]).appendTo(".files-upload-rename");for(n in OC.upload.dropzone_uploaded_files)e("<input/>").attr("type","hidden").attr("name",n).attr("value",OC.upload.dropzone_uploaded_files[n]).appendTo(".files-upload-rename")}}},e(document).ready(function(){OC.upload.isPost="true"==e('form.files-upload-rename input[name="post"]').val(),e("form.files-upload-rename").bind("keypress",function(e){13===e.keyCode&&e.preventDefault()});var a={".uploadfiles":"COMPUTER",".gdrive-upload":"GOOGLE_DRIVE",".skydrive-upload":"SKYDRIVE",".dropbox-upload":"DROPBOX",".gmail-upload":"GMAIL",".box-upload":"BOX",".picasa-upload":"PICASA",".ftp-upload":"FTP",".webdav-upload":"WEBDAV",".facebook-upload":"FACEBOOK"};l.each(a,function(a,o){e(o).click(function(e){OC.upload.launchFilepickerDialog(e,a)})}),e("form.files-upload-rename button[type=submit]").click(function(e){return OC.upload.preSubmissionHandler(e),OC.upload.isPost?!1:!0}),e("button[name=select-file]").click(function(a){return OC.upload.isPost?e(".upload-drag-drop").click():e("input[class=manual-upload]:last").click(),a.preventDefault(),a.stopPropagation(),!1});var p=e(".post-new-upload-dialog .upload-drag-drop");p.length>0&&(e(".post-new-upload-dialog .upload-drag-drop").dropzone({url:"/api/file-upload/",maxFilesize:5,createImageThumbnails:!1}),o.forElement(".post-new-upload-dialog .upload-drag-drop").on("sending",function(a,o,l){function p(a){var o,l,p,d=null;if(document.cookie&&""!==document.cookie)for(o=document.cookie.split(";"),l=0;l<o.length;l++)if(p=e.trim(o[l]),p.substring(0,a.length+1)===a+"="){d=decodeURIComponent(p.substring(a.length+1));break}return d}function d(e){var a=document.location.host,o=document.location.protocol,l="//"+a,p=o+l;return e===p||e.slice(0,p.length+1)===p+"/"||e===l||e.slice(0,l.length+1)===l+"/"||!/^(\/\/|http:|https:).*/.test(e)}var i=e(this)[0].options.url;d(i)&&o.setRequestHeader("X-CSRFToken",p("csrftoken")),l.append("user",OC.config.user.id),e(".post-new-upload-dialog form input[name=project]").length>0&&l.append("project",e("form.files-upload-rename input[name=project]").val()),e(".post-new-upload-dialog form input[name=collection]").length>0&&l.append("collection",e("form.files-upload-rename input[name=collection]").val()),OC.upload.isPost&&OC.upload.addToUploadList(null,a.name,0,"dropzone-item")}),o.forElement(".post-new-upload-dialog .upload-drag-drop").on("uploadprogress",function(a,o){OC.upload.isPost&&e(".single-upload .dz-progress .dz-upload").css("width",o+"%")}),o.forElement(".post-new-upload-dialog .upload-drag-drop").on("success",function(a,o){var l,p=JSON.parse(o);for(l in p)OC.upload.dropzone_uploaded_files[l]=p[l].title;e(".dz-preview .dz-filename > span:contains("+OC.upload.dropzone_uploaded_files[l]+")").addClass(l),e(".dz-filename span",a.previewElement).attr("contenteditable",!0),OC.upload.newFileUploadListener(),OC.upload.isPost&&OC.upload.updateSingleItemKey(l)})),e("input[type=file]").change(OC.upload.onFileInputChange)})});