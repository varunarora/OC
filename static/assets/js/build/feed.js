define(["jquery","underscore","timeago"],function(e,t){t.extend(OC.feed,{wrapper:t.template('<div class="user feed-item"><a href="<%= actor_url %>" class="user-photo" style="background-image: url(\'<%= actor_thumbnail %>\');" title="<%= actor_name %>"></a><div class="user-description"><a href="<%= actor_url %>"><%= actor_name %></a> <%= feed_body %></div></div>'),date:t.template(' <span class="feed-item-date" title="<%= target_created %>"></span>'),url:t.template('<a href="<%= target_url %>"><%= target %></a>'),userURL:t.template('<a href="<%= target_user_url %>"><%= target_user %></a>'),urlItem:t.template('<div class="oer-external feed-oer-external" style="background-image: url(\'<%= target_thumbnail %>\');"><div id="oer-info"><div id="oer-details"><ul><li><span class="oer-info-caption">URL:</span> <span class="oer-info-detail"><a href="<%= target_direct_url %>"><%= target_direct_url_trimmed %>...</a></span></li><li><span class="oer-info-caption">License:</span> <span class="oer-info-detail"> <%= target_license %></span></li><li><span class="oer-info-caption">Posted on:</span> <span class="oer-info-detail"> <%= target_created %></span></li></ul></div><div id="oer-get"><a href="<%= target_direct_url %>" target="_blank"><button class="action-button">Open website</button></a></div></div></div>'),videoItem:t.template('<div class="oer-video feed-oer-video"><% if (target_provider === \'youtube\'){ %><iframe width="475" height="267" src="http://www.youtube.com/embed/<%= target_video_tag %>?wmode=opaque" frameborder="0" allowfullscreen></iframe><% } else if (target_provider === \'vimeo\'){ %><iframe src="http://player.vimeo.com/video/<%= target_video_tag %>?title=0&amp;byline=0&amp;portrait=0&amp;badge=0&amp;color=ffffff"width="475" height="267" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe><% } %></div>'),uploadItem:t.template('<div class="activity-object-wrapper"><div class="user-photo" style="background-image: url(\'<%= target_thumbnail %>\');"></div><div class="user-description"><a href="<%= target_url %>"><%= target_title %></a><br/><a href="<%= target_download_url %>" target="_blank">Download</a> &#183; <%= target_size %></div></div>'),commentItem:t.template('<div class="activity-object-wrapper"><blockquote>"<%= action %>"</blockquote></div>'),newPost:t.template('<a href="<%= target_url %>">new post</a>'),group:t.template('<a href="<%= context_url %>"><%= context %></a>. '),newGroup:t.template('<a href="<%= action_url %>"><%= action %></a>. '),membership:t.template('<a href="<%= target_url %>"><%= target %></a>. '),post:t.template('<a href="<%= target_url %>">discussion post</a>'),discussionItem:t.template('<div class="activity-object-wrapper"><div class="user-photo" style="background-image: url(\'<%= target_user_thumbnail %>\');"></div><div class="user-description"><a href="<%= target_user_url %>"><%= target_user %></a><%= target %><blockquote>"<%= action %>"</blockquote></div></div>'),groupItem:t.template('<div class="activity-project-wrapper"><div class="projects-item"><a href="<%= target_url %>" title="<%= target_description %>"><div style="background-image: url(\'<%= target_thumbnail %>\'); background-position: <%= target_thumbnail_position[0] %>% <%= target_thumbnail_position[1] %>%;" class="profile-projects-item-description-wrapper"><div class="profile-projects-item-description"><div class="profile-projects-item-title bold"><%= target %></div></div></div></a></div></div>'),infiniteScroll:function(){if(OC.feed.feedCount>10&&OC.config.user.id){var t,d=e(".lazy-load-button");e(".home-profile-content").on("DOMContentLoaded load resize scroll",function(){e.contains(document,d[0])&&isElementInViewport(d)&&!d.hasClass("loading")&&(d.addClass("loading"),e.get("/user/api/load-feed/home/"+OC.config.profile.id+"/from/"+OC.feed.currentCount+"/",function(i){if("true"==i.status)if(0!==i.feeds.length){var a;for(t=0;t<i.feeds.length;t++)a=OC.feed.buildFeedItem(i.feeds[i.feeds[t]]),e(".feed-list").append(a),newAppendedFeedItem=e(".feed-list .feed-item:last"),e(".feed-item-date",newAppendedFeedItem).timeago();OC.feed.currentCount+=i.feeds.length}else d.remove();else OC.popup(i.message,i.title);d.removeClass("loading")},"json"))})}},buildFeedItem:function(e){if(feed_item_body="","resource"===e.action_type)"url"==e.target_type?(feed_item_body+="created a new link ",feed_item_body+=OC.feed.url(e),feed_item_body+=OC.feed.date(e),e.target_direct_url_trimmed=e.target_direct_url.substring(0,30),feed_item_body+=OC.feed.urlItem(e)):"document"==e.target_type?(feed_item_body+="created a new document ",feed_item_body+=OC.feed.url(e),feed_item_body+=OC.feed.date(e)):"video"==e.target_type?(feed_item_body+="created a video link ",feed_item_body+=OC.feed.url(e),feed_item_body+=OC.feed.date(e),feed_item_body+=OC.feed.videoItem(e)):"attachment"==e.target_type&&(feed_item_body+="uploaded a new file. ",feed_item_body+=OC.feed.date(e),feed_item_body+=OC.feed.uploadItem(e));else if("comment"===e.action_type)if("resource"===e.target_type)feed_item_body+="commented on the resource ",feed_item_body+=OC.feed.url(e),feed_item_body+=OC.feed.commentItem(e);else if("comment"===e.target_type)e.action_id===e.target_id?(feed_item_body+="wrote a ",feed_item_body+=OC.feed.newPost(e),feed_item_body+=" in ",feed_item_body+=OC.feed.group(e),feed_item_body+=OC.feed.date(e),feed_item_body+=OC.feed.commentItem(e)):(feed_item_body+="commented on a ",feed_item_body+=OC.feed.post(e),feed_item_body+=" in ",feed_item_body+=OC.feed.group(e),feed_item_body+=OC.feed.date(e),feed_item_body+=OC.feed.discussionItem(e));else if("membership"===e.action_type)feed_item_body+="just joined the group ",feed_item_body+=OC.feed.membership(e),feed_item_body+=OC.feed.date(e),feed_item_body+=OC.feed.groupItem(e);else if("project"===e.action_type)feed_item_body+="created the group ",feed_item_body+=OC.feed.membership(e),feed_item_body+=OC.feed.date(e),e.target=e.action,e.target_url=e.action_url,e.target_description=e.action_description,e.target_thumbnail=e.action_thumbnail,e.target_thumbnail_position=e.action_thumbnail_position,feed_item_body+=OC.feed.groupItem(e);else if("favorite"===e.action_type)switch(feed_item_body+="favorited ",feed_item_body+=OC.feed.userURL(e),feed_item_body+="'s resource ",feed_item_body+=OC.feed.url(e),feed_item_body=OC.feed.date(e),e.target_type){case"url":e.target_direct_url_trimmed=e.target_direct_url.substring(0,30),feed_item_body+=OC.feed.urlItem(e);break;case"video":feed_item_body+=OC.feed.videoItem(e);break;case"attachment":feed_item_body+=OC.feed.uploadItem(e)}else"favorite"===e.action_type&&(feed_item_body+="created a folder ",feed_item_body+=OC.feed.url(e),feed_item_body+=OC.feed.date(e));return e.feed_body=feed_item_body,feed_item_html=OC.feed.wrapper(e)}})});