define(["atomic","immutable","curriculumActions","curriculumSettings"],function(t,n,e,i){var o={_textbooks:null,_units:null,_standards:null,_numWeeks:null,fetch:function(e){var o=this;t.get("/curriculum/api/curriculum/"+i.getID()+"/").success(function(t){o._textbooks=n.fromJS(t.textbooks),o._units=n.fromJS(t.units),o._standards=n.fromJS(t.standards),e()})},linkUnitsToTextbooks:function(){var t,e,i=this;this._textbooks=this._textbooks.map(function(o){return t=n.List(),o.get("units").forEach(function(n){e=i._units.find(function(t){return t.get("id")===n.get("id")}),e=e.set("textbookID",n.get("textbook_id")),t=t.push(e.get("id"))}),o.set("units",t)})},getTextbookFromUnitID:function(t){return this._textbooks.find(function(n){return n.get("units").find(function(n){return n.id===t})})},setUnitPeriods:function(){var t,n,e=this;if("weekly"==i.getPeriods().title){t=this._units.map(function(t){return textbook=e.getTextbookFromUnitID(t.id),n=t.get("period"),{id:t.get("id"),textbook:textbook?textbook:null,textbookTitle:textbook?textbook.get("title"):null,title:t.get("title"),textbookThumbnail:textbook?textbook.get("thumbnail"):null,begin:n&&n.has("begin")?n.get("begin"):null,end:n&&n.has("end")?n.get("end"):null,from:n&&n.has("from")?n.get("from"):null,to:n&&n.has("to")?n.get("to"):null}}),t=t.filter(function(t){return null!==t.end}).sortBy(function(t){return t.begin});var o=t.max(function(t,n){return t.end>n.end}),u=t.min(function(t,n){return t.begin>n.begin}),r=o?o.end:null,s=u?u.begin:null;return this._numWeeks=null!==r&&null!==s?Math.ceil((r-s)/7):0,t}if("terms"==view.props.settings.periods.title){t=OC.explorer.units.flatMap(function(t){return textbook=view.getTextbookFromUnitID(t.get("id")),n=t.get("period"),{id:t.get("id"),title:t.get("title"),textbook:textbook,textbookTitle:textbook?textbook.get("title"):null,textbookThumbnail:textbook?textbook.get("thumbnail"):null,type:n&&n.has("type")?n.get("type"):null,position:n&&n.has("position")?n.get("position"):null,parent:n&&n.has("parent")?n.get("parent"):null,unit:n&&n.has("unit")?n.get("unit"):null}});var l;return t.forEach(function(t){l=view.props.settings.periods.data[t.parent],l.has("count")?l.count+=1:l.count=1}),t}},init:function(t){function n(t){require(["spin"],function(n){OC.curriculum.hasOwnProperty("spinner")?OC.curriculum.spinner.spin(o):OC.curriculum.spinner=new n(OC.spinner.options).spin(o),t()})}{var i=this,o=OC.curriculum.loadButton;document.querySelector(".ajax-loader-wrapper")}n(function(){OC.curriculum.hasOwnProperty("spinner")&&OC.curriculum.spinner.spin(o),i.fetch(function(){OC.curriculum.spinner.stop(),i.linkUnitsToTextbooks(),e.initTextbooks(i._textbooks),e.initUnits(i.setUnitPeriods()),e.setNumWeeks(i._numWeeks),t()})})}};return o});